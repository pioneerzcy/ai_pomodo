<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>番茄钟 H5（单文件版）</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { background: #f8fafc; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,monospace; }
  </style>
</head>
<body class="min-h-screen text-slate-800">
  <div class="max-w-5xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">番茄钟 H5（单文件）</h1>
        <p class="text-sm text-slate-500">语音建计划 · 本地持久化 · 按天分析 · 导出 CSV</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-voice" class="px-3 py-2 rounded-xl bg-slate-900 text-white shadow">🎤 语音开计划</button>
        <button id="btn-export" class="px-3 py-2 rounded-xl bg-white border shadow">导出 CSV</button>
      </div>
    </header>

    <section class="mt-6 grid md:grid-cols-2 gap-4">
      <!-- 计划设置 -->
      <div class="bg-white rounded-2xl shadow p-5 border">
        <h2 class="font-semibold mb-4">当前计划</h2>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <label class="space-y-1">
            <div class="text-slate-500">一级标签</div>
            <input id="primaryTag" class="w-full rounded-xl border px-3 py-2" value="写作" />
          </label>
          <label class="space-y-1">
            <div class="text-slate-500">二级标签</div>
            <input id="secondaryTag" class="w-full rounded-xl border px-3 py-2" value="长文章" />
          </label>
          <label class="space-y-1">
            <div class="text-slate-500">循环次数</div>
            <input id="cycles" type="number" min="1" class="w-full rounded-xl border px-3 py-2" value="4" />
          </label>
          <label class="space-y-1">
            <div class="text-slate-500">专注(分钟)</div>
            <input id="focusMin" type="number" min="1" class="w-full rounded-xl border px-3 py-2" value="25" />
          </label>
          <label class="space-y-1">
            <div class="text-slate-500">休息(分钟)</div>
            <input id="restMin" type="number" min="0" class="w-full rounded-xl border px-3 py-2" value="5" />
          </label>
          <div></div>
        </div>
        <div class="mt-3 text-xs text-slate-500">总时长约 <span id="totalMinutes">120</span> 分钟（含休息）。</div>
        <div class="mt-4 flex gap-2 flex-wrap">
          <button id="btn-start" class="px-4 py-2 rounded-xl bg-emerald-600 text-white shadow">开始</button>
          <button id="btn-pause" class="px-4 py-2 rounded-xl bg-amber-500 text-white shadow">暂停</button>
          <button id="btn-reset" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800 shadow">重置</button>
          <button id="btn-skip" class="px-4 py-2 rounded-xl bg-sky-500 text-white shadow">跳过当前阶段</button>
        </div>
        <div id="lastTranscript" class="mt-3 text-xs text-slate-500 hidden"></div>
      </div>

      <!-- 计时器 -->
      <div class="bg-white rounded-2xl shadow p-5 border flex flex-col items-center justify-center">
        <div class="text-slate-500 text-sm mb-2">第 <span id="cycleIndex">1</span> / <span id="cycleTotal">4</span> 轮</div>
        <div class="text-slate-900 text-lg mb-1">当前：<span id="phaseLabel">专注</span></div>
        <div id="clock" class="mono text-6xl md:text-7xl tracking-wider">25:00</div>
        <div class="mt-4 text-center text-sm text-slate-600"><span id="tagShow">写作 / 长文章</span></div>
      </div>
    </section>

    <!-- 图表 -->
    <section class="mt-8 bg-white rounded-2xl shadow p-5 border">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">近 14 天专注分钟数</h2>
        <div class="text-xs text-slate-500">本地存储，隐私不出端</div>
      </div>
      <div class="h-64 mt-2"><canvas id="daysChart"></canvas></div>
    </section>

    <!-- 按天明细 -->
    <section class="mt-6 bg-white rounded-2xl shadow p-5 border">
      <h2 class="font-semibold mb-3">按天明细</h2>
      <div id="dailyList" class="space-y-4 text-sm"></div>
    </section>

    <!-- 使用说明 -->
    <section class="mt-8 bg-white rounded-2xl shadow p-5 border">
      <h2 class="font-semibold mb-3">使用说明</h2>
      <ol class="list-decimal pl-5 space-y-2 text-sm leading-6 text-slate-700">
        <li>点击右上角「🎤 语音开计划」，说：
          <div class="mt-1 p-2 bg-slate-50 rounded border text-slate-600">
            请帮我开启一个计划，一级标签是<strong>写作</strong>，二级标签是<strong>长文章</strong>，共<strong>12</strong>次循环，每次专注<strong>25</strong>分钟休息<strong>5</strong>分钟
          </div>
          识别成功后会自动套入参数并开始计时。</li>
        <li>或在「当前计划」里手动调整参数，点「开始」。</li>
        <li>每完成一轮<strong>专注</strong>会自动保存到本地；右上角可「导出 CSV」。</li>
        <li>数据仅保存在浏览器 localStorage；如需云同步可后续接入 Supabase/Firestore。</li>
      </ol>
      <div class="mt-3 text-xs text-slate-500">提示：iOS Safari 的 Web Speech API 支持较弱；建议使用安卓/桌面 Chrome 获得最佳体验。</div>
    </section>

    <footer class="py-8 text-center text-xs text-slate-400">Made for your focus • 单文件版</footer>
  </div>

  <script>
    // ====== 工具函数 ======
    const pad = (n) => (n < 10 ? '0' + n : '' + n);
    const fmtTime = (sec) => `${pad(Math.floor(sec/60))}:${pad(sec%60)}`;
    const dayKey = (d) => { const dt = d instanceof Date ? d : new Date(d); return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}` };
    const todayKey = () => dayKey(new Date());
    const uuid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    const LS_PLAN = 'pomodoro_single_plan_v1';
    const LS_RECS = 'pomodoro_single_records_v1';

    const $ = (id) => document.getElementById(id);

    // ====== 状态 ======
    let plan = JSON.parse(localStorage.getItem(LS_PLAN) || 'null') || {
      id: uuid(),
      primaryTag: '写作',
      secondaryTag: '长文章',
      cycles: 4,
      focusMin: 25,
      restMin: 5,
      createdAt: Date.now()
    };
    let cycleIndex = 1; // 1..cycles
    let phase = 'focus'; // focus | rest | done
    let running = false;
    let leftSec = plan.focusMin * 60;
    let tick = null;
    let records = JSON.parse(localStorage.getItem(LS_RECS) || '[]');

    function savePlan() { localStorage.setItem(LS_PLAN, JSON.stringify(plan)); }
    function saveRecords() { localStorage.setItem(LS_RECS, JSON.stringify(records)); }

    // ====== UI 绑定 ======
    function refreshSummary() {
      $('cycleIndex').textContent = cycleIndex;
      $('cycleTotal').textContent = plan.cycles;
      $('phaseLabel').textContent = phase === 'focus' ? '专注' : (phase === 'rest' ? '休息' : '完成');
      $('clock').textContent = fmtTime(leftSec);
      $('tagShow').textContent = `${plan.primaryTag} / ${plan.secondaryTag}`;
      const total = plan.focusMin * plan.cycles + plan.restMin * (plan.cycles - 1);
      $('totalMinutes').textContent = total;
    }

    function loadPlanToInputs() {
      $('primaryTag').value = plan.primaryTag;
      $('secondaryTag').value = plan.secondaryTag;
      $('cycles').value = plan.cycles;
      $('focusMin').value = plan.focusMin;
      $('restMin').value = plan.restMin;
      refreshSummary();
    }

    // ====== 通知 + 声音 ======
    function notify(title, body) {
      if (!('Notification' in window)) return;
      if (Notification.permission === 'granted') new Notification(title, { body });
    }
    function beep(ms = 220) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 660; o.connect(g); g.connect(ctx.destination);
        o.start(); setTimeout(() => { o.stop(); ctx.close(); }, ms);
      } catch {}
    }

    // ====== 阶段切换 ======
    function onPhaseEnd() {
      beep(); const now = Date.now();
      if (phase === 'focus') {
        // 记录一次专注完成
        const rec = {
          id: uuid(), planId: plan.id, planName: `${plan.primaryTag}/${plan.secondaryTag} ${plan.cycles}轮`,
          primaryTag: plan.primaryTag, secondaryTag: plan.secondaryTag,
          cycleNumber: cycleIndex, dateKey: todayKey(),
          startAt: now - plan.focusMin * 60 * 1000, endAt: now, durationMin: plan.focusMin,
        };
        records.unshift(rec); saveRecords();
        notify('专注结束', `${plan.primaryTag}/${plan.secondaryTag} 第${cycleIndex}轮完成`);
        // 进入休息
        phase = 'rest'; leftSec = plan.restMin * 60; running = true; startTick();
      } else if (phase === 'rest') {
        if (cycleIndex < plan.cycles) {
          cycleIndex += 1; phase = 'focus'; leftSec = plan.focusMin * 60; running = true; startTick();
          notify('休息结束', `开始第${cycleIndex}轮专注`);
        } else {
          phase = 'done'; running = false; stopTick();
          notify('番茄钟完成', `${plan.cycles} 轮全部完成`);
        }
      }
      refreshSummary();
      renderDaily();
      drawChart();
    }

    function startTick() {
      stopTick();
      tick = setInterval(() => {
        if (leftSec <= 1) { leftSec = 0; refreshSummary(); onPhaseEnd(); return; }
        leftSec -= 1; $('clock').textContent = fmtTime(leftSec);
      }, 1000);
    }
    function stopTick() { if (tick) clearInterval(tick); tick = null; }

    // ====== 控件事件 ======
    $('btn-start').onclick = () => {
      if (phase === 'done') { phase = 'focus'; cycleIndex = 1; leftSec = plan.focusMin * 60; }
      running = true; startTick(); refreshSummary();
    };
    $('btn-pause').onclick = () => { running = false; stopTick(); };
    $('btn-reset').onclick = () => { running = false; stopTick(); phase = 'focus'; cycleIndex = 1; leftSec = plan.focusMin * 60; refreshSummary(); };
    $('btn-skip').onclick = () => { leftSec = 0; onPhaseEnd(); };

    $('primaryTag').oninput = (e) => { plan.primaryTag = e.target.value; savePlan(); refreshSummary(); };
    $('secondaryTag').oninput = (e) => { plan.secondaryTag = e.target.value; savePlan(); refreshSummary(); };
    $('cycles').oninput = (e) => { plan.cycles = Math.max(1, parseInt(e.target.value||'1',10)); savePlan(); refreshSummary(); };
    $('focusMin').oninput = (e) => { const v = Math.max(1, parseInt(e.target.value||'25',10)); plan.focusMin = v; savePlan(); if (phase==='focus') leftSec = v*60; refreshSummary(); };
    $('restMin').oninput = (e) => { const v = Math.max(0, parseInt(e.target.value||'5',10)); plan.restMin = v; savePlan(); if (phase==='rest') leftSec = v*60; refreshSummary(); };

    // ====== 语音识别 ======
    let recog = null; let listening = false;
    function parseCommand(text) {
      const out = {};
      const m1 = text.match(/一级标签(?:是|为)?([^，,\s]+)/);
      const m2 = text.match(/二级标签(?:是|为)?([^，,\s]+)/);
      const m3 = text.match(/共?(\d+)次?循环/);
      const m4 = text.match(/每次?专注(\d+)(?:分钟|min)?/);
      const m5 = text.match(/休息(\d+)(?:分钟|min)?/);
      if (m1) out.primaryTag = m1[1];
      if (m2) out.secondaryTag = m2[1];
      if (m3) out.cycles = parseInt(m3[1],10);
      if (m4) out.focusMin = parseInt(m4[1],10);
      if (m5) out.restMin = parseInt(m5[1],10);
      if (!out.focusMin) { const m = text.match(/(25|45|50)[^\d]{0,10}(分钟|min)[^\d]{0,10}(专注|工作)/); if (m) out.focusMin = parseInt(m[1],10); }
      if (!out.restMin)  { const m = text.match(/(5|10|15)[^\d]{0,10}(分钟|min)[^\d]{0,10}(休息)/); if (m) out.restMin = parseInt(m[1],10); }
      if (!out.cycles)   { const m = text.match(/(\d+)[^\d]{0,5}(次|轮|循环)/); if (m) out.cycles = parseInt(m[1],10); }
      return out;
    }
    $('btn-voice').onclick = () => {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert('当前浏览器不支持语音识别（建议桌面/安卓 Chrome）。'); return; }
      if (!listening) {
        if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
        recog = new SR(); recog.lang = 'zh-CN'; recog.interimResults = false; recog.maxAlternatives = 1;
        recog.onresult = (ev) => {
          const text = Array.from(ev.results).map(r=>r[0].transcript).join(' ');
          const cfg = parseCommand(text);
          const last = $('lastTranscript'); last.classList.remove('hidden'); last.textContent = '上次语音：' + text;
          plan = { ...plan, ...cfg, id: uuid(), createdAt: Date.now() };
          savePlan(); loadPlanToInputs(); phase = 'focus'; cycleIndex = 1; leftSec = plan.focusMin*60; running = true; startTick();
        };
        recog.onend = () => { listening = false; $('btn-voice').textContent = '🎤 语音开计划'; };
        recog.onerror = () => { listening = false; $('btn-voice').textContent = '🎤 语音开计划'; };
        listening = true; $('btn-voice').textContent = '正在聆听…';
        try { recog.start(); } catch {}
      }
    };

    // ====== 导出 CSV ======
    $('btn-export').onclick = () => {
      const headers = ['id','planId','planName','primaryTag','secondaryTag','cycleNumber','dateKey','startAt','endAt','durationMin'];
      const lines = [headers.join(',')];
      for (const r of [...records].reverse()) {
        const row = headers.map(h => {
          let v = r[h];
          return (typeof v === 'string') ? '"' + v.replace(/"/g,'""') + '"' : v;
        });
        lines.push(row.join(','));
      }
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `pomodoro_records_${todayKey()}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    };

    // ====== 图表 & 明细 ======
    let chart = null;
    function sumByDay(dateKey) { return records.filter(r=>r.dateKey===dateKey).reduce((s,r)=>s+r.durationMin,0); }
    function build14Days() {
      const res = []; const now = new Date();
      for (let i=13; i>=0; i--) { const d = new Date(now); d.setDate(now.getDate()-i); const k = dayKey(d); res.push({ k, label: k.slice(5), minutes: sumByDay(k) }); }
      return res;
    }
    function drawChart() {
      const data = build14Days();
      const ctx = document.getElementById('daysChart');
      const ds = {
        labels: data.map(d=>d.label),
        datasets: [{ label: '分钟', data: data.map(d=>d.minutes) }]
      };
      if (chart) { chart.data = ds; chart.update(); return; }
      chart = new Chart(ctx, { type: 'bar', data: ds, options: { responsive: true, scales: { y: { beginAtZero: true } } } });
    }

    function renderDaily() {
      const box = $('dailyList'); box.innerHTML = '';
      const map = new Map();
      for (const r of records) { if (!map.has(r.dateKey)) map.set(r.dateKey, []); map.get(r.dateKey).push(r); }
      const days = Array.from(map.entries()).map(([date, recs])=>({date, recs})).sort((a,b)=>a.date<b.date?1:-1);
      if (days.length === 0) { box.innerHTML = '<div class="text-slate-500">暂无记录，完成一次专注后这里会出现数据。</div>'; return; }
      for (const {date, recs} of days) {
        const total = recs.reduce((s,r)=>s+r.durationMin,0);
        const byTag = {};
        for (const r of recs) { const k = `${r.primaryTag}/${r.secondaryTag}`; byTag[k] = (byTag[k]||0) + r.durationMin; }
        const tagChips = Object.entries(byTag).map(([k,v])=>`<span class="px-2 py-1 bg-slate-100 rounded-full">${k}: ${v} 分钟</span>`).join(' ');
        const rows = recs.map(r=>`<tr class="border-t"><td class="py-1 pr-4">${new Date(r.startAt).toLocaleTimeString()} - ${new Date(r.endAt).toLocaleTimeString()}</td><td class="py-1 pr-4">${r.primaryTag}/${r.secondaryTag}</td><td class="py-1 pr-4">${r.cycleNumber}</td><td class="py-1 pr-4">${r.durationMin} 分钟</td></tr>`).join('');
        const html = `
          <div class="border rounded-xl p-3">
            <div class="flex items-center justify-between"><div class="font-medium">${date}</div><div class="text-sm text-slate-500">共 ${recs.length} 次 · ${total} 分钟</div></div>
            <div class="mt-2 text-sm text-slate-600 flex flex-wrap gap-2">${tagChips}</div>
            <div class="mt-3 overflow-x-auto">
              <table class="min-w-full text-sm"><thead><tr class="text-left text-slate-500"><th class="py-1 pr-4">时间段</th><th class="py-1 pr-4">标签</th><th class="py-1 pr-4">第几轮</th><th class="py-1 pr-4">时长</th></tr></thead><tbody>${rows}</tbody></table>
            </div>
          </div>`;
        const div = document.createElement('div'); div.innerHTML = html; box.appendChild(div.firstElementChild);
      }
    }

    // ====== 初始化 ======
    (function init(){
      if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
      loadPlanToInputs(); refreshSummary(); renderDaily(); drawChart();
    })();
  </script>
</body>
</html>
