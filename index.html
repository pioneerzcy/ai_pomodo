<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç•ªèŒ„é’Ÿ H5ï¼ˆå•æ–‡ä»¶ç‰ˆï¼‰</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { background: #f8fafc; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,monospace; }
  </style>
</head>
<body class="min-h-screen text-slate-800">
  <div class="max-w-5xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">ç•ªèŒ„é’Ÿ H5ï¼ˆå•æ–‡ä»¶ï¼‰</h1>
        <p class="text-sm text-slate-500">è¯­éŸ³å»ºè®¡åˆ’ Â· æœ¬åœ°æŒä¹…åŒ– Â· æŒ‰å¤©åˆ†æ Â· å¯¼å‡º CSV</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-voice" class="px-3 py-2 rounded-xl bg-slate-900 text-white shadow">ğŸ¤ è¯­éŸ³å¼€è®¡åˆ’</button>
        <button id="btn-export" class="px-3 py-2 rounded-xl bg-white border shadow">å¯¼å‡º CSV</button>
      </div>
    </header>

    <section class="mt-6 grid md:grid-cols-2 gap-4">
      <!-- è®¡åˆ’è®¾ç½® -->
      <div class="bg-white rounded-2xl shadow p-5 border">
        <h2 class="font-semibold mb-4">å½“å‰è®¡åˆ’</h2>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <label class="space-y-1">
            <div class="text-slate-500">ä¸€çº§æ ‡ç­¾</div>
            <input id="primaryTag" class="w-full rounded-xl border px-3 py-2" value="å†™ä½œ" />
          </label>
          <label class="space-y-1">
            <div class="text-slate-500">äºŒçº§æ ‡ç­¾</div>
            <input id="secondaryTag" class="w-full rounded-xl border px-3 py-2" value="é•¿æ–‡ç« " />
          </label>
          <label class="space-y-1">
            <div class="text-slate-500">å¾ªç¯æ¬¡æ•°</div>
            <input id="cycles" type="number" min="1" class="w-full rounded-xl border px-3 py-2" value="4" />
          </label>
          <label class="space-y-1">
            <div class="text-slate-500">ä¸“æ³¨(åˆ†é’Ÿ)</div>
            <input id="focusMin" type="number" min="1" class="w-full rounded-xl border px-3 py-2" value="25" />
          </label>
          <label class="space-y-1">
            <div class="text-slate-500">ä¼‘æ¯(åˆ†é’Ÿ)</div>
            <input id="restMin" type="number" min="0" class="w-full rounded-xl border px-3 py-2" value="5" />
          </label>
          <div></div>
        </div>
        <div class="mt-3 text-xs text-slate-500">æ€»æ—¶é•¿çº¦ <span id="totalMinutes">120</span> åˆ†é’Ÿï¼ˆå«ä¼‘æ¯ï¼‰ã€‚</div>
        <div class="mt-4 flex gap-2 flex-wrap">
          <button id="btn-start" class="px-4 py-2 rounded-xl bg-emerald-600 text-white shadow">å¼€å§‹</button>
          <button id="btn-pause" class="px-4 py-2 rounded-xl bg-amber-500 text-white shadow">æš‚åœ</button>
          <button id="btn-reset" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800 shadow">é‡ç½®</button>
          <button id="btn-skip" class="px-4 py-2 rounded-xl bg-sky-500 text-white shadow">è·³è¿‡å½“å‰é˜¶æ®µ</button>
        </div>
        <div id="lastTranscript" class="mt-3 text-xs text-slate-500 hidden"></div>
      </div>

      <!-- è®¡æ—¶å™¨ -->
      <div class="bg-white rounded-2xl shadow p-5 border flex flex-col items-center justify-center">
        <div class="text-slate-500 text-sm mb-2">ç¬¬ <span id="cycleIndex">1</span> / <span id="cycleTotal">4</span> è½®</div>
        <div class="text-slate-900 text-lg mb-1">å½“å‰ï¼š<span id="phaseLabel">ä¸“æ³¨</span></div>
        <div id="clock" class="mono text-6xl md:text-7xl tracking-wider">25:00</div>
        <div class="mt-4 text-center text-sm text-slate-600"><span id="tagShow">å†™ä½œ / é•¿æ–‡ç« </span></div>
      </div>
    </section>

    <!-- å›¾è¡¨ -->
    <section class="mt-8 bg-white rounded-2xl shadow p-5 border">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">è¿‘ 14 å¤©ä¸“æ³¨åˆ†é’Ÿæ•°</h2>
        <div class="text-xs text-slate-500">æœ¬åœ°å­˜å‚¨ï¼Œéšç§ä¸å‡ºç«¯</div>
      </div>
      <div class="h-64 mt-2"><canvas id="daysChart"></canvas></div>
    </section>

    <!-- æŒ‰å¤©æ˜ç»† -->
    <section class="mt-6 bg-white rounded-2xl shadow p-5 border">
      <h2 class="font-semibold mb-3">æŒ‰å¤©æ˜ç»†</h2>
      <div id="dailyList" class="space-y-4 text-sm"></div>
    </section>

    <!-- ä½¿ç”¨è¯´æ˜ -->
    <section class="mt-8 bg-white rounded-2xl shadow p-5 border">
      <h2 class="font-semibold mb-3">ä½¿ç”¨è¯´æ˜</h2>
      <ol class="list-decimal pl-5 space-y-2 text-sm leading-6 text-slate-700">
        <li>ç‚¹å‡»å³ä¸Šè§’ã€ŒğŸ¤ è¯­éŸ³å¼€è®¡åˆ’ã€ï¼Œè¯´ï¼š
          <div class="mt-1 p-2 bg-slate-50 rounded border text-slate-600">
            è¯·å¸®æˆ‘å¼€å¯ä¸€ä¸ªè®¡åˆ’ï¼Œä¸€çº§æ ‡ç­¾æ˜¯<strong>å†™ä½œ</strong>ï¼ŒäºŒçº§æ ‡ç­¾æ˜¯<strong>é•¿æ–‡ç« </strong>ï¼Œå…±<strong>12</strong>æ¬¡å¾ªç¯ï¼Œæ¯æ¬¡ä¸“æ³¨<strong>25</strong>åˆ†é’Ÿä¼‘æ¯<strong>5</strong>åˆ†é’Ÿ
          </div>
          è¯†åˆ«æˆåŠŸåä¼šè‡ªåŠ¨å¥—å…¥å‚æ•°å¹¶å¼€å§‹è®¡æ—¶ã€‚</li>
        <li>æˆ–åœ¨ã€Œå½“å‰è®¡åˆ’ã€é‡Œæ‰‹åŠ¨è°ƒæ•´å‚æ•°ï¼Œç‚¹ã€Œå¼€å§‹ã€ã€‚</li>
        <li>æ¯å®Œæˆä¸€è½®<strong>ä¸“æ³¨</strong>ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼›å³ä¸Šè§’å¯ã€Œå¯¼å‡º CSVã€ã€‚</li>
        <li>æ•°æ®ä»…ä¿å­˜åœ¨æµè§ˆå™¨ localStorageï¼›å¦‚éœ€äº‘åŒæ­¥å¯åç»­æ¥å…¥ Supabase/Firestoreã€‚</li>
      </ol>
      <div class="mt-3 text-xs text-slate-500">æç¤ºï¼šiOS Safari çš„ Web Speech API æ”¯æŒè¾ƒå¼±ï¼›å»ºè®®ä½¿ç”¨å®‰å“/æ¡Œé¢ Chrome è·å¾—æœ€ä½³ä½“éªŒã€‚</div>
    </section>

    <footer class="py-8 text-center text-xs text-slate-400">Made for your focus â€¢ å•æ–‡ä»¶ç‰ˆ</footer>
  </div>

  <script>
    // ====== å·¥å…·å‡½æ•° ======
    const pad = (n) => (n < 10 ? '0' + n : '' + n);
    const fmtTime = (sec) => `${pad(Math.floor(sec/60))}:${pad(sec%60)}`;
    const dayKey = (d) => { const dt = d instanceof Date ? d : new Date(d); return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}` };
    const todayKey = () => dayKey(new Date());
    const uuid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    const LS_PLAN = 'pomodoro_single_plan_v1';
    const LS_RECS = 'pomodoro_single_records_v1';

    const $ = (id) => document.getElementById(id);

    // ====== çŠ¶æ€ ======
    let plan = JSON.parse(localStorage.getItem(LS_PLAN) || 'null') || {
      id: uuid(),
      primaryTag: 'å†™ä½œ',
      secondaryTag: 'é•¿æ–‡ç« ',
      cycles: 4,
      focusMin: 25,
      restMin: 5,
      createdAt: Date.now()
    };
    let cycleIndex = 1; // 1..cycles
    let phase = 'focus'; // focus | rest | done
    let running = false;
    let leftSec = plan.focusMin * 60;
    let tick = null;
    let records = JSON.parse(localStorage.getItem(LS_RECS) || '[]');

    function savePlan() { localStorage.setItem(LS_PLAN, JSON.stringify(plan)); }
    function saveRecords() { localStorage.setItem(LS_RECS, JSON.stringify(records)); }

    // ====== UI ç»‘å®š ======
    function refreshSummary() {
      $('cycleIndex').textContent = cycleIndex;
      $('cycleTotal').textContent = plan.cycles;
      $('phaseLabel').textContent = phase === 'focus' ? 'ä¸“æ³¨' : (phase === 'rest' ? 'ä¼‘æ¯' : 'å®Œæˆ');
      $('clock').textContent = fmtTime(leftSec);
      $('tagShow').textContent = `${plan.primaryTag} / ${plan.secondaryTag}`;
      const total = plan.focusMin * plan.cycles + plan.restMin * (plan.cycles - 1);
      $('totalMinutes').textContent = total;
    }

    function loadPlanToInputs() {
      $('primaryTag').value = plan.primaryTag;
      $('secondaryTag').value = plan.secondaryTag;
      $('cycles').value = plan.cycles;
      $('focusMin').value = plan.focusMin;
      $('restMin').value = plan.restMin;
      refreshSummary();
    }

    // ====== é€šçŸ¥ + å£°éŸ³ ======
    function notify(title, body) {
      if (!('Notification' in window)) return;
      if (Notification.permission === 'granted') new Notification(title, { body });
    }
    function beep(ms = 220) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 660; o.connect(g); g.connect(ctx.destination);
        o.start(); setTimeout(() => { o.stop(); ctx.close(); }, ms);
      } catch {}
    }

    // ====== é˜¶æ®µåˆ‡æ¢ ======
    function onPhaseEnd() {
      beep(); const now = Date.now();
      if (phase === 'focus') {
        // è®°å½•ä¸€æ¬¡ä¸“æ³¨å®Œæˆ
        const rec = {
          id: uuid(), planId: plan.id, planName: `${plan.primaryTag}/${plan.secondaryTag} ${plan.cycles}è½®`,
          primaryTag: plan.primaryTag, secondaryTag: plan.secondaryTag,
          cycleNumber: cycleIndex, dateKey: todayKey(),
          startAt: now - plan.focusMin * 60 * 1000, endAt: now, durationMin: plan.focusMin,
        };
        records.unshift(rec); saveRecords();
        notify('ä¸“æ³¨ç»“æŸ', `${plan.primaryTag}/${plan.secondaryTag} ç¬¬${cycleIndex}è½®å®Œæˆ`);
        // è¿›å…¥ä¼‘æ¯
        phase = 'rest'; leftSec = plan.restMin * 60; running = true; startTick();
      } else if (phase === 'rest') {
        if (cycleIndex < plan.cycles) {
          cycleIndex += 1; phase = 'focus'; leftSec = plan.focusMin * 60; running = true; startTick();
          notify('ä¼‘æ¯ç»“æŸ', `å¼€å§‹ç¬¬${cycleIndex}è½®ä¸“æ³¨`);
        } else {
          phase = 'done'; running = false; stopTick();
          notify('ç•ªèŒ„é’Ÿå®Œæˆ', `${plan.cycles} è½®å…¨éƒ¨å®Œæˆ`);
        }
      }
      refreshSummary();
      renderDaily();
      drawChart();
    }

    function startTick() {
      stopTick();
      tick = setInterval(() => {
        if (leftSec <= 1) { leftSec = 0; refreshSummary(); onPhaseEnd(); return; }
        leftSec -= 1; $('clock').textContent = fmtTime(leftSec);
      }, 1000);
    }
    function stopTick() { if (tick) clearInterval(tick); tick = null; }

    // ====== æ§ä»¶äº‹ä»¶ ======
    $('btn-start').onclick = () => {
      if (phase === 'done') { phase = 'focus'; cycleIndex = 1; leftSec = plan.focusMin * 60; }
      running = true; startTick(); refreshSummary();
    };
    $('btn-pause').onclick = () => { running = false; stopTick(); };
    $('btn-reset').onclick = () => { running = false; stopTick(); phase = 'focus'; cycleIndex = 1; leftSec = plan.focusMin * 60; refreshSummary(); };
    $('btn-skip').onclick = () => { leftSec = 0; onPhaseEnd(); };

    $('primaryTag').oninput = (e) => { plan.primaryTag = e.target.value; savePlan(); refreshSummary(); };
    $('secondaryTag').oninput = (e) => { plan.secondaryTag = e.target.value; savePlan(); refreshSummary(); };
    $('cycles').oninput = (e) => { plan.cycles = Math.max(1, parseInt(e.target.value||'1',10)); savePlan(); refreshSummary(); };
    $('focusMin').oninput = (e) => { const v = Math.max(1, parseInt(e.target.value||'25',10)); plan.focusMin = v; savePlan(); if (phase==='focus') leftSec = v*60; refreshSummary(); };
    $('restMin').oninput = (e) => { const v = Math.max(0, parseInt(e.target.value||'5',10)); plan.restMin = v; savePlan(); if (phase==='rest') leftSec = v*60; refreshSummary(); };

    // ====== è¯­éŸ³è¯†åˆ« ======
    let recog = null; let listening = false;
    function parseCommand(text) {
      const out = {};
      const m1 = text.match(/ä¸€çº§æ ‡ç­¾(?:æ˜¯|ä¸º)?([^ï¼Œ,\s]+)/);
      const m2 = text.match(/äºŒçº§æ ‡ç­¾(?:æ˜¯|ä¸º)?([^ï¼Œ,\s]+)/);
      const m3 = text.match(/å…±?(\d+)æ¬¡?å¾ªç¯/);
      const m4 = text.match(/æ¯æ¬¡?ä¸“æ³¨(\d+)(?:åˆ†é’Ÿ|min)?/);
      const m5 = text.match(/ä¼‘æ¯(\d+)(?:åˆ†é’Ÿ|min)?/);
      if (m1) out.primaryTag = m1[1];
      if (m2) out.secondaryTag = m2[1];
      if (m3) out.cycles = parseInt(m3[1],10);
      if (m4) out.focusMin = parseInt(m4[1],10);
      if (m5) out.restMin = parseInt(m5[1],10);
      if (!out.focusMin) { const m = text.match(/(25|45|50)[^\d]{0,10}(åˆ†é’Ÿ|min)[^\d]{0,10}(ä¸“æ³¨|å·¥ä½œ)/); if (m) out.focusMin = parseInt(m[1],10); }
      if (!out.restMin)  { const m = text.match(/(5|10|15)[^\d]{0,10}(åˆ†é’Ÿ|min)[^\d]{0,10}(ä¼‘æ¯)/); if (m) out.restMin = parseInt(m[1],10); }
      if (!out.cycles)   { const m = text.match(/(\d+)[^\d]{0,5}(æ¬¡|è½®|å¾ªç¯)/); if (m) out.cycles = parseInt(m[1],10); }
      return out;
    }
    $('btn-voice').onclick = () => {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼ˆå»ºè®®æ¡Œé¢/å®‰å“ Chromeï¼‰ã€‚'); return; }
      if (!listening) {
        if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
        recog = new SR(); recog.lang = 'zh-CN'; recog.interimResults = false; recog.maxAlternatives = 1;
        recog.onresult = (ev) => {
          const text = Array.from(ev.results).map(r=>r[0].transcript).join(' ');
          const cfg = parseCommand(text);
          const last = $('lastTranscript'); last.classList.remove('hidden'); last.textContent = 'ä¸Šæ¬¡è¯­éŸ³ï¼š' + text;
          plan = { ...plan, ...cfg, id: uuid(), createdAt: Date.now() };
          savePlan(); loadPlanToInputs(); phase = 'focus'; cycleIndex = 1; leftSec = plan.focusMin*60; running = true; startTick();
        };
        recog.onend = () => { listening = false; $('btn-voice').textContent = 'ğŸ¤ è¯­éŸ³å¼€è®¡åˆ’'; };
        recog.onerror = () => { listening = false; $('btn-voice').textContent = 'ğŸ¤ è¯­éŸ³å¼€è®¡åˆ’'; };
        listening = true; $('btn-voice').textContent = 'æ­£åœ¨è†å¬â€¦';
        try { recog.start(); } catch {}
      }
    };

    // ====== å¯¼å‡º CSV ======
    $('btn-export').onclick = () => {
      const headers = ['id','planId','planName','primaryTag','secondaryTag','cycleNumber','dateKey','startAt','endAt','durationMin'];
      const lines = [headers.join(',')];
      for (const r of [...records].reverse()) {
        const row = headers.map(h => {
          let v = r[h];
          return (typeof v === 'string') ? '"' + v.replace(/"/g,'""') + '"' : v;
        });
        lines.push(row.join(','));
      }
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `pomodoro_records_${todayKey()}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    };

    // ====== å›¾è¡¨ & æ˜ç»† ======
    let chart = null;
    function sumByDay(dateKey) { return records.filter(r=>r.dateKey===dateKey).reduce((s,r)=>s+r.durationMin,0); }
    function build14Days() {
      const res = []; const now = new Date();
      for (let i=13; i>=0; i--) { const d = new Date(now); d.setDate(now.getDate()-i); const k = dayKey(d); res.push({ k, label: k.slice(5), minutes: sumByDay(k) }); }
      return res;
    }
    function drawChart() {
      const data = build14Days();
      const ctx = document.getElementById('daysChart');
      const ds = {
        labels: data.map(d=>d.label),
        datasets: [{ label: 'åˆ†é’Ÿ', data: data.map(d=>d.minutes) }]
      };
      if (chart) { chart.data = ds; chart.update(); return; }
      chart = new Chart(ctx, { type: 'bar', data: ds, options: { responsive: true, scales: { y: { beginAtZero: true } } } });
    }

    function renderDaily() {
      const box = $('dailyList'); box.innerHTML = '';
      const map = new Map();
      for (const r of records) { if (!map.has(r.dateKey)) map.set(r.dateKey, []); map.get(r.dateKey).push(r); }
      const days = Array.from(map.entries()).map(([date, recs])=>({date, recs})).sort((a,b)=>a.date<b.date?1:-1);
      if (days.length === 0) { box.innerHTML = '<div class="text-slate-500">æš‚æ— è®°å½•ï¼Œå®Œæˆä¸€æ¬¡ä¸“æ³¨åè¿™é‡Œä¼šå‡ºç°æ•°æ®ã€‚</div>'; return; }
      for (const {date, recs} of days) {
        const total = recs.reduce((s,r)=>s+r.durationMin,0);
        const byTag = {};
        for (const r of recs) { const k = `${r.primaryTag}/${r.secondaryTag}`; byTag[k] = (byTag[k]||0) + r.durationMin; }
        const tagChips = Object.entries(byTag).map(([k,v])=>`<span class="px-2 py-1 bg-slate-100 rounded-full">${k}: ${v} åˆ†é’Ÿ</span>`).join(' ');
        const rows = recs.map(r=>`<tr class="border-t"><td class="py-1 pr-4">${new Date(r.startAt).toLocaleTimeString()} - ${new Date(r.endAt).toLocaleTimeString()}</td><td class="py-1 pr-4">${r.primaryTag}/${r.secondaryTag}</td><td class="py-1 pr-4">${r.cycleNumber}</td><td class="py-1 pr-4">${r.durationMin} åˆ†é’Ÿ</td></tr>`).join('');
        const html = `
          <div class="border rounded-xl p-3">
            <div class="flex items-center justify-between"><div class="font-medium">${date}</div><div class="text-sm text-slate-500">å…± ${recs.length} æ¬¡ Â· ${total} åˆ†é’Ÿ</div></div>
            <div class="mt-2 text-sm text-slate-600 flex flex-wrap gap-2">${tagChips}</div>
            <div class="mt-3 overflow-x-auto">
              <table class="min-w-full text-sm"><thead><tr class="text-left text-slate-500"><th class="py-1 pr-4">æ—¶é—´æ®µ</th><th class="py-1 pr-4">æ ‡ç­¾</th><th class="py-1 pr-4">ç¬¬å‡ è½®</th><th class="py-1 pr-4">æ—¶é•¿</th></tr></thead><tbody>${rows}</tbody></table>
            </div>
          </div>`;
        const div = document.createElement('div'); div.innerHTML = html; box.appendChild(div.firstElementChild);
      }
    }

    // ====== åˆå§‹åŒ– ======
    (function init(){
      if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
      loadPlanToInputs(); refreshSummary(); renderDaily(); drawChart();
    })();
  </script>
</body>
</html>
